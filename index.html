<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>üéµ Absolute Pitch Trainer</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root { --bg:#0f172a; --card:#1e293b; --muted:#334155; --good:#16a34a; --bad:#dc2626; --text:#e5e7eb; --accent:#fbbf24; --neutral:#94a3b8; --muted2:#2a3a54; }
  *{box-sizing:border-box}
  body{font-family:'Fredoka',sans-serif;background:var(--bg);color:var(--text);margin:0;padding:20px}
  .card{max-width:1060px;margin:auto;background:var(--card);border-radius:20px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.15)}
  h1,h2,h3{margin:0 0 8px}
  button{margin:6px;padding:10px 16px;border-radius:12px;border:none;cursor:pointer;font-size:14px;background:var(--muted);color:var(--text);transition:transform .06s ease, filter .12s ease, background .12s ease, border-color .12s ease}
  button:hover{transform:translateY(-1px)}
  button:active{transform:translateY(0)}
  button:disabled{opacity:.55; cursor:not-allowed; background:var(--muted2); border:1.5px dashed #4a5a78}
  input,select{padding:10px 12px;border-radius:12px;border:1px solid var(--muted);background:#0b1224;color:var(--text)}
  select{appearance:none;background-image:linear-gradient(45deg,transparent 50%,var(--text) 50%),linear-gradient(135deg,var(--text) 50%,transparent 50%),linear-gradient(to right,transparent,transparent);
         background-position:calc(100% - 20px) 16px, calc(100% - 14px) 16px, 100% 0; background-size:6px 6px,6px 6px, 2.5em 2.5em; background-repeat:no-repeat}
  label{opacity:.9}
  .screen{display:none}
  .pill{display:inline-flex;align-items:center;background:var(--muted);padding:8px 12px;border-radius:16px;font-size:13px;margin:6px;white-space:nowrap}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .note-pad{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
  .note{min-height:64px;font-size:18px;border-radius:14px}
  .note.inert{background:#253147 !important; border:1.5px dashed #41506d; cursor:not-allowed}
  .wide{grid-column:1 / -1}
  #barStatus{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
  #barControls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  #feedbackOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;pointer-events:none}
  #feedbackBox{min-width:240px;text-align:center;padding:16px 18px;border-radius:14px;font-weight:700;font-size:20px;box-shadow:0 20px 60px rgba(0,0,0,.35);transform:scale(.9);opacity:0;transition:transform .15s,opacity .15s}
  #feedbackOverlay.show #feedbackBox{transform:scale(1.05);opacity:1}
  #shepardOverlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:60}
  #shepardBox{background:#0b1325;border:1px solid #22304d;padding:20px 24px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);text-align:center}
  #bootError{display:none;position:fixed;left:12px;right:12px;bottom:12px;background:#7f1d1d;color:#fff;padding:10px 12px;border-radius:10px;box-shadow:0 4px 18px rgba(0,0,0,.35);z-index:9999;font:13px/1.35 system-ui,sans-serif;white-space:pre-wrap}

  /* Flappy */
  #flappyModal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
  #flappyCanvas{background:#0b1325;width:320px;height:480px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35);cursor:pointer;-webkit-tap-highlight-color:transparent;touch-action:none;user-select:none;-webkit-user-select:none;-webkit-touch-callout:none;outline:none}

  input[type="range"].disabled{opacity:.4;filter:grayscale(1)}

  /* Suggestion banner */
  #suggestBanner{display:none;margin:8px 0 4px;padding:10px 12px;border-radius:12px;background:#22304d;border:1px solid #2f4166;color:#e8efff;align-items:center;gap:10px}
  #suggestBanner button{margin:0 4px;padding:8px 12px;border-radius:10px;font-size:13px}
  #btnRestartSet{background:var(--good)}
  #btnDismissSuggest{background:var(--muted)}

  /* Modals */
  #strictModal,#welcomeModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1000;background:rgba(0,0,0,.55);pointer-events:auto}
  #strictBox,#welcomeBox{width:min(760px,92vw);background:#0b1325;border:1px solid #22304d;border-radius:16px;padding:18px 20px;box-shadow:0 20px 60px rgba(0,0,0,.5)}
  #strictBox h3,#welcomeBox h2{margin:0 0 8px}
  #strictBtns,#welcomeBtns{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
  #btnStrictResume{background:var(--good)}
  #btnStrictMenu{background:var(--muted)}
  #welcomeBtns button{background:var(--muted)}
  #tutorialWrap{background:#0b1224;border:1px solid #26324a;border-radius:12px;padding:12px;margin:10px 0}

  /* Progress (charts) */
  #progressCard{margin-top:14px}
  #progressControls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
  #progressLegend{display:flex;gap:12px;align-items:center;font-size:13px;opacity:.9}
  .legendDot{width:12px;height:12px;border-radius:50%}

  /* Mixed Test */
  #mixedTestScreen .note{min-height:58px}
  /* Tutorial pager */
  .tPage{display:none}
  .tPage.active{display:block}
  #tutorialNav{display:flex;gap:8px;justify-content:space-between;margin-top:10px}
  #tBack{visibility:hidden}

  /* Special exercise strip */
  #specialBar{display:none;align-items:center;justify-content:space-between;background:#22304d;border:1px solid #2f4166;color:#e8efff;padding:8px 12px;border-radius:10px;margin-bottom:10px}

  /* Scope picker CTA styling */
  .scopeWrap{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:12px;background:#17223a;border:1px solid #2b3b5c}
  .scopeWrap:hover{box-shadow:0 0 0 2px rgba(251,191,36,.25) inset}
  .scopeSelect{background:#0b1224;border:1.5px solid #3b4b6b;border-radius:10px;padding:8px 36px 8px 10px;font-weight:600}
  .scopeSelect:focus{outline:none; box-shadow:0 0 0 2px #fbbf24}
  .scopeBtn{background:#fbbf24;color:#0b0f1c;font-weight:700}
</style>
</head>
<body>
  <!-- Start -->
  <div class="card screen" id="startScreen">
    <h1>Welcome!</h1>
    <p>Enter your name to begin:</p>
    <input id="userNameInput" placeholder="Your name" />
    <button id="startBtn">Start ‚ñ∂</button>
  </div>

  <!-- Welcome / Tutorial -->
  <div id="welcomeModal" aria-modal="true" role="dialog">
    <div id="welcomeBox" class="card">
      <h2>üìò How this program works</h2>
      <div id="tutorialWrap">
        <div class="tPage active" id="tPage1">
          <h3>üéØ Goal</h3>
          <p>Learn to recognize the <strong>12 pitches</strong> by ear (C, C#/Db, D, D#/Eb, E, F, F#/Gb, G, G#/Ab, A, A#/Bb, B). You start with a single pitch and add more.</p>
          <ul>
            <li><strong>Unlock order (study):</strong> alternate semitones around F: <strong>F, E, F#/Gb, Eb, G, D, Ab, Db, A, C, Bb, B</strong>.</li>
            <li>Training uses <strong>sets</strong> (how many pitches you‚Äôre learning) and <strong>blocks</strong> (24 per set).</li>
            <li><strong>RT (reaction time)</strong> = max time to answer; it increases slightly with set size.</li>
          </ul>
        </div>
        <div class="tPage" id="tPage2">
          <h3>‚è± Daily session</h3>
          <ul>
            <li>Train for <strong>20 minutes</strong> (timer runs only while actively training).</li>
            <li>Menus, Flappy, and the 20-s <strong>Shepard tone</strong> don‚Äôt count.</li>
            <li>Blocks <strong>1‚Äì20</strong> with feedback; <strong>21‚Äì24</strong> are tests (no feedback).</li>
          </ul>
        </div>
        <div class="tPage" id="tPage3">
          <h3>üéπ Octaves (per study)</h3>
          <ul>
            <li>Training tones span <strong>three octaves (C4‚ÄìB6)</strong> and are randomized within blocks.</li>
            <li>This encourages learning the <em>chroma</em> (pitch class), not just pitch height.</li>
            <li>Tone length: <strong>800 ms</strong>.</li>
          </ul>
        </div>
        <div class="tPage" id="tPage4">
          <h3>üß™ Special exercises (Block 15)</h3>
          <ul>
            <li>When you‚Äôre learning <strong>‚â• 5 pitches</strong>, Block 15 becomes specials:</li>
            <li><strong>Exercise A</strong>: 12 trials with feedback ‚Äî <em>Target (pitch)</em> vs <em>Other (OOB)</em>.</li>
            <li><strong>Exercise B</strong>: 22 trials without feedback ‚Äî same task.</li>
          </ul>
        </div>
        <div class="tPage" id="tPage5">
          <h3>üê§ Flappy breaks</h3>
          <ul>
            <li>Reward mini-game; every flap plays a random pitch.</li>
            <li>Timer stays paused until you press <strong>Play</strong> again.</li>
          </ul>
        </div>
      </div>
      <div id="welcomeBtns">
        <div id="tutorialNav" style="width:100%">
          <button id="tBack">‚óÄ Back</button>
          <div style="flex:1"></div>
          <button id="tNext">Next ‚ñ∂</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Menu -->
  <div class="card screen" id="menuScreen">
    <h1 id="greeting">Absolute Pitch Trainer</h1>
    <div class="row">
      <span class="pill" id="capInfo">Left: 20:00</span>
      <span class="pill" id="weekPill">This week: 0 hrs 0 mins</span>
      <span class="pill" id="lockoutPill" style="display:none">üîí Locked</span>
    </div>
    <div class="row">
      <button id="menuStart">‚ñ∂ Start Training</button>
      <button id="playFlappy">üê§ Flappy (lockout only)</button>
      <button id="menuMixedTest">üß™ Mixed Tone Test</button>
      <button id="resetLockout">‚ö° Reset lockout/timer</button>
      <button id="menuReset">‚ü≤ Reset (factory)</button>
    </div>

    <!-- Scope looks obviously changeable now -->
    <div class="row" style="margin-top:8px;gap:12px">
      <div class="scopeWrap">
        <span style="opacity:.9">Current scope:</span>
        <select id="setSizeSelect" class="scopeSelect"></select>
        <button id="applySetBtn" class="scopeBtn">Change‚Ä¶</button>
      </div>
    </div>

    <!-- Progress -->
    <div class="card" id="progressCard">
      <h3>üìà Progress</h3>
      <div id="progressControls">
        <label for="dataSelect">Data:</label>
        <select id="dataSelect" style="padding-right:28px">
          <option value="TRAINING" selected>Training</option>
          <option value="TEST">Test</option>
        </select>
        <label for="pitchSelect">Pitch:</label>
        <select id="pitchSelect" style="padding-right:28px"></select>
        <label for="granularitySelect">View:</label>
        <select id="granularitySelect" style="padding-right:28px">
          <option value="WEEKLY" selected>Weekly (Day 1 ‚Üí 7)</option>
          <option value="OVERALL">Overall (Week 1 ‚Üí 8)</option>
        </select>
        <div id="progressLegend">
          <span class="legendDot" style="background:var(--good)"></span> <span id="legGood">Correct %</span>
          <span class="legendDot" style="background:var(--bad);margin-left:12px)"></span> <span id="legBad">Incorrect %</span>
          <span class="legendDot" style="background:var(--neutral);margin-left:12px)"></span> <span id="legTrend">No-trial day</span>
        </div>
      </div>
      <canvas id="progressCanvas" width="1000" height="300" style="width:100%;height:auto;border-radius:12px;background:#0b1224;border:1px solid #26324a"></canvas>
    </div>
  </div>

  <!-- Trainer -->
  <div class="card screen" id="trainerScreen">
    <div id="specialBar" class="row">
      <span id="specialText">Special Exercise</span>
      <span class="pill" id="specialCount">0 / 0</span>
    </div>

    <div id="suggestBanner" class="row">
      <span>Struggling in the test phase. Restart this pitch set?</span>
      <div style="margin-left:auto"></div>
      <button id="btnRestartSet">Restart set</button>
      <button id="btnDismissSuggest">Dismiss</button>
    </div>

    <div id="barStatus">
      <span class="pill" id="promptPill">Press Play to start</span>
      <span class="pill" id="setInfo">Set 1 / 12</span>
      <span class="pill" id="blockInfo">Block 1 / 24</span>
      <span class="pill" id="accInfo">Acc 0% (req 20%)</span>
      <span class="pill" id="autoInfo">Auto-next: Off</span>
      <span class="pill" id="delayInfo">RT limit: 1183ms ‚Ä¢ Delay: 1000ms</span>
      <span class="pill" id="timerInfo">Time left: 20:00</span>
    </div>
    <div id="barControls">
      <button id="btnPlay">‚ñ∂ Play</button>
      <button id="btnPause">‚è∏ Pause</button>
      <button id="btnToggleAuto">‚èØ Toggle Auto-next</button>
      <input id="delaySlider" type="range" min="0" max="2000" step="50" value="1000" style="width:220px">
      <button id="btnBackMenu">‚Ü© Menu</button>
    </div>

    <!-- Note pad -->
    <div class="note-pad" id="notePad"></div>
    <div class="note-pad" style="margin-top:6px">
      <button class="note wide" id="btnOOB" type="button">Out of Bounds</button>
    </div>

    <!-- Binary pad for specials -->
    <div class="note-pad" id="binaryPad" style="display:none">
      <button class="note" id="btnTarget" type="button">Target</button>
      <button class="note" id="btnOther" type="button">Other (OOB)</button>
    </div>

    <p style="opacity:.75;margin-top:8px">800 ms tone ‚Ä¢ RT limit adapts with set size ‚Ä¢ 24 blocks per set ‚Ä¢ Octaves randomized (C4‚ÄìB6)</p>
  </div>

  
  <!-- Mixed Test (self-assessment) -->
  <div class="card screen" id="mixedTestScreen">
    <h2>üß™ Mixed Tone Self‚ÄëTest</h2>
    <p style="opacity:.9">
      This mixes <strong>sine waves</strong> and your <strong>piano samples</strong>. You‚Äôll hear 20 tones (no feedback),
      and you guess the pitch from <strong>all 12 notes</strong>. Use it at the <strong>start and end of your 8‚Äëweek plan</strong>,
      or weekly to track progress. The tracker adds one point per completed test.
    </p>
    <div class="row" style="margin-bottom:8px">
      <span class="pill" id="mixedStatus">Ready ‚Äî 20 trials</span>
    </div>
    <div class="row">
      <button id="mixedStart">‚ñ∂ Start Test</button>
      <button id="mixedBack">‚Ü© Menu</button>
    </div>
    <div class="note-pad" id="mixedPad" style="margin-top:8px"></div>
  </div>

  <!-- New pitch modal after passing a set -->
  <div id="pitchAddModal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1001;background:rgba(0,0,0,.55)">
    <div class="card" style="max-width:520px;text-align:center">
      <h3>üéâ Well done!</h3>
      <p id="pitchAddText" style="opacity:.9;margin:8px 0 12px"></p>
      <div class="row" style="justify-content:center">
        <button id="pitchAddHear">üîä Hear it</button>
        <button id="pitchAddClose">Continue</button>
      </div>
    </div>
  </div>


  <!-- Feedback -->
  <div id="feedbackOverlay"><div id="feedbackBox"></div></div>

  <!-- Shepard overlay -->
  <div id="shepardOverlay">
    <div id="shepardBox">
      <h3>üîá Memory reset</h3>
      <p>Playing a 20-second Shepard tone‚Ä¶</p>
      <p id="shepardCountdown">20</p>
    </div>
  </div>

  <!-- Flappy -->
  <div id="flappyModal">
    <div class="card" style="text-align:center">
      <h3>üê§ Flappy Break</h3>
      <canvas id="flappyCanvas" width="320" height="480"></canvas>
      <div style="margin-top:8px">
        <button id="flappyClose">Close</button>
      </div>
      <p id="flappyScore">Score: 0 ‚Ä¢ Best: 0</p>
      <p style="opacity:.8;font-size:12px">Tap/click (or Space) to flap. First tap starts ‚Äî each flap plays a random pitch.</p>
    </div>
  </div>

  <!-- Strict session modal -->
  <div id="strictModal" aria-modal="true" role="dialog">
    <div id="strictBox" class="card">
      <h3>‚ö†Ô∏è Don‚Äôt break your session</h3>
      <p>Training is meant to be one strict 20-minute session without interruption. Please finish, then wait until tomorrow.</p>
      <div id="strictBtns">
        <button id="btnStrictResume">Resume Training</button>
        <button id="btnStrictMenu">Go to Menu</button>
      </div>
    </div>
  </div>

  <div id="bootError"></div>

<script>
/* ------------------ SAFE HELPERS + STATE ------------------ */
function byId(id){ return document.getElementById(id); }
function safe(id, fn){ const el=byId(id); if(el) try{ fn(el); }catch(e){report(e);} }
function showFlex(id){ safe(id, el=> el.style.display='flex'); }
function showBlock(id){ safe(id, el=> el.style.display='block'); }
function hide(id){ safe(id, el=> el.style.display='none'); }
function text(id, v){ safe(id, el=> el.textContent=v); }
function report(err){ const el=byId('bootError'); if(!el) return; el.style.display='block'; el.textContent = '‚ö†Ô∏è Script error: ' + (err && err.message ? err.message : String(err)); if(err && err.stack){ el.textContent += '\n' + err.stack; } }

let state;
try{
  state = JSON.parse(localStorage.getItem('apTrainer')||'null') || {
    userName:null,
    levelIndex:1,
    levelTrials:0, levelCorrect:0,
    shepardDoneFor:-1,
    sessions:[], trials:[],
    startDate:null, lockoutUntil:null, capResetAt:null,
    testFailStreak:0, suggestShownSet:null,
    lastSeen:null, flappyHighScore:0,
    thisWeekIdx:0, thisWeekMs:0,
    levelFailCounts:{},
    specialRanForLevel:null
  };
} catch(e){
  state = { userName:null, levelIndex:1, levelTrials:0, levelCorrect:0, shepardDoneFor:-1, sessions:[], trials:[], startDate:null, lockoutUntil:null, capResetAt:null, testFailStreak:0, suggestShownSet:null, lastSeen:null, flappyHighScore:0, thisWeekIdx:0, thisWeekMs:0, levelFailCounts:{}, specialRanForLevel:null };
}
function save(){ try{ localStorage.setItem('apTrainer', JSON.stringify(state)); }catch(e){ report(e); } }
window.state = state;

/* ------------------ CONSTANTS ------------------ */
const AUDIO_PIANO='./audio';
const PC=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];
const PC_LABEL={ C:"C", Db:"C#/Db", D:"D", Eb:"D#/Eb", E:"E", F:"F", Gb:"F#/Gb", G:"G", Ab:"G#/Ab", A:"A", Bb:"A#/Bb", B:"B" };
const UNLOCK_ORDER = ["F","E","Gb","Eb","G","D","Ab","Db","A","C","Bb","B"];

const LEVELS_PER_SET=24, SETS=12, LEVELS_TOTAL=SETS*LEVELS_PER_SET;
const TONE_MS=800;
const THRESH_24=[0.20,0.25,0.30,0.35,0.40,0.45,0.50,0.55,0.60,0.60,0.65,0.70,0.75,0.78,0.80,0.83,0.85,0.88,0.90,0.90,0.90,0.90,0.90,0.90];
function blockHasFeedback(block){ return block<=20; }
function rtWindowForSet(n){const a=1183,b=2028;return Math.round(a+(n-1)*(b-a)/11);}
const OOB_RATE=0.25;
const SESS_DAILY_MS=20*60*1000;
const LOCKOUT_MS=6*60*60*1000;
const WEEKLY_TARGET_MS=2*60*60*1000;
const LATENCY_CUSHION_MS = 120;

/* ------------------ TIME HELPERS ------------------ */
function fmtMMSS(ms){ const s=Math.max(0,Math.floor(ms/1000)); const m=Math.floor(s/60); const ss=String(s%60).padStart(2,'0'); return `${m}:${ss}`; }
function fmtHMM(ms){ const s=Math.max(0,Math.floor(ms/1000)); const h=Math.floor(s/3600); const m=Math.floor((s%3600)/60); return `${h}h ${String(m).padStart(2,'0')}m`; }
function fmtHrsMins(ms){ let s=Math.max(0, Math.floor(ms/1000)); const h=Math.floor(s/3600); const m=Math.floor((s%3600)/60); return `${h} hr${h===1?'':'s'} ${m} min${m===1?'':'s'}`; }
function dateAtMidnight(ts){ const d=new Date(ts); d.setHours(0,0,0,0); return d.getTime(); }
function todayKey(ts){ return dateAtMidnight(ts||Date.now()); }
function weekIndex(ts){ const base=ts||Date.now(); if(!state.startDate) return 0; return Math.floor((base-state.startDate)/(7*24*60*60*1000)); }
function currentWeekIdx(){ return weekIndex(Date.now()); }
function weekStartTs(){ if(!state.startDate) return todayKey(Date.now()); const idx=currentWeekIdx(); const base=dateAtMidnight(state.startDate); return base + idx*7*86400000; }

/* ------------------ DURATION ------------------ */
function activeDuration(session){
  const endAt = session.end ?? Date.now();
  let total = Math.max(0, endAt - session.start);
  for(const p of (session.pauses||[])){
    const pe = p.end ?? Date.now();
    const ps = p.start ?? session.start;
    const a = Math.max(session.start, ps);
    const b = Math.min(endAt, pe);
    if(b > a) total -= (b - a);
  }
  return Math.max(0, total);
}

/* ------------------ FLAGS/TIMERS ------------------ */
let sessionActive=false, paused=false;
let rtTimer=null, autoTimer=null, tickId=null;
function stopAllTimers(){ if(tickId){ clearInterval(tickId); tickId=null; } if(rtTimer){ clearTimeout(rtTimer); rtTimer=null; } if(autoTimer){ clearTimeout(autoTimer); autoTimer=null; }

/* one-shot suppression so strict modal doesn't appear right after specials */
}
let suppressStrictOnce=false;

/* ------------------ SANITY ------------------ */
function sealDanglingSession(){
  try{
    const rec = (state.sessions||[])[(state.sessions||[]).length - 1];
    if(!rec) return;
    if(rec.end == null){
      const now = Date.now();
      if(rec.pauses && rec.pauses.length){
        const last = rec.pauses[rec.pauses.length-1];
        if(last && !last.end) last.end = now;
      }
      rec.end = now; save();
    }
  }catch(e){ report(e); }
}

/* ------------------ UI ------------------ */
function showScreen(id){
  document.querySelectorAll('.screen').forEach(el=> el.style.display='none');
  if(id === 'menuScreen'){
    sessionActive=false; paused=false;
    stopAllTimers(); sealDanglingSession(); updateCapsUI();
    try{ populatePitchSelect(); drawChart(); }catch(_){}
  } else if(id !== 'trainerScreen'){
    if(sessionActive && !paused){ pauseStart('nav-away'); }
  }
  const el = byId(id); if(el) el.style.display='block';
}
function ensureWeekRoll(){ const wi=currentWeekIdx(); if(state.thisWeekIdx!==wi){ state.thisWeekIdx=wi; state.thisWeekMs=0; save(); } }
function isLocked(){ return state.lockoutUntil && Date.now() < state.lockoutUntil; }
function updateCapsUI(){
  ensureWeekRoll();
  const left = Math.max(0, SESS_DAILY_MS - msUsedQuota());
  text('capInfo', `Left: ${fmtMMSS(left)}`);
  const usedW = state.thisWeekMs || 0;
  const wp = byId('weekPill');
  if(wp){
    wp.textContent = `This week: ${fmtHrsMins(usedW)}`;
    let color = '#dc2626';
    if(usedW >= 1*3600000 && usedW < 2*3600000) color = 'var(--text)';
    else if(usedW >= 2*3600000 && usedW < 3*3600000) color = '#16a34a';
    else if(usedW >= 3*3600000) color = '#fbbf24';
    wp.style.color = color;
    wp.title = `Target: ${fmtHMM(WEEKLY_TARGET_MS)}`;
  }
  const locked = isLocked();
  const lp = byId('lockoutPill');
  if(lp){
    if(locked){ lp.style.display='inline-flex'; lp.textContent = `üîí Locked (${fmtHMM(state.lockoutUntil - Date.now())} left)`; }
    else lp.style.display='none';
  }
  const pf = byId('playFlappy'); if(pf) pf.disabled = !locked;
}
function setFromIndex(i){return Math.floor((i-1)/LEVELS_PER_SET)+1;}
function blockFromIndex(i){return ((i-1)%LEVELS_PER_SET)+1;}
function thresholdForIndex(i){return THRESH_24[blockFromIndex(i)-1];}
function trainedSet(k){ return UNLOCK_ORDER.slice(0,k); }

/* ------------------ AUDIO ------------------ */
let ACTX=null; const BUF_CACHE=new Map();
function getCtx(){ if(!ACTX){ ACTX=new (window.AudioContext||window.webkitAudioContext)(); } return ACTX; }
async function resumeCtx(){ try{ const ctx=getCtx(); if(ctx.state==='suspended') await ctx.resume(); }catch(e){ report(e); } }
async function loadBuffer(url){ if(BUF_CACHE.has(url)) return BUF_CACHE.get(url); const res=await fetch(url); if(!res.ok) throw new Error('Missing audio '+url); const arr=await res.arrayBuffer(); const buf=await getCtx().decodeAudioData(arr); BUF_CACHE.set(url,buf); return buf; }
async function closeAudio(){ try{ if(ACTX){ await ACTX.close(); } }catch(_){} finally{ ACTX=null; BUF_CACHE.clear(); } }

/* Always play a tone (sample -> oscillator -> fallback) */
async function playSample(note){
  try{
    await resumeCtx();
    const ctx = getCtx();
    try{
      const url = `${AUDIO_PIANO}/${note}.mp3`;
      const buf = await loadBuffer(url);
      const src = ctx.createBufferSource();
      src.buffer = buf;
      const g = ctx.createGain(); g.gain.value = 1;
      src.connect(g).connect(ctx.destination);
      const t = ctx.currentTime;
      src.start(t); src.stop(t + TONE_MS/1000);
      return;
    }catch(_e){}
    const m=/^([A-G](?:b)?)(\d)$/.exec(note);
    const pc=m?m[1]:'A', o=m?+m[2]:4;
    const idx={C:0,Db:1,D:2,Eb:3,E:4,F:5,Gb:6,G:7,Ab:8,A:9,Bb:10,B:11};
    const semis=(idx[pc]??9)+(o-4)*12;
    const freq=440*Math.pow(2,(semis-9)/12);
    const osc = ctx.createOscillator(); const g = ctx.createGain();
    osc.type='sine'; osc.frequency.value=freq;
    const t0 = ctx.currentTime;
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.linearRampToValueAtTime(0.25, t0 + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + TONE_MS/1000);
    osc.connect(g).connect(ctx.destination);
    osc.start(t0); osc.stop(t0 + TONE_MS/1000);
  }catch(e){
    try{
      const ctx=getCtx(); const osc=ctx.createOscillator(); const g=ctx.createGain();
      osc.type='sine'; osc.frequency.value=440;
      const t0=ctx.currentTime; g.gain.setValueAtTime(0.0001,t0); g.gain.linearRampToValueAtTime(0.2,t0+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t0+0.3);
      osc.connect(g).connect(ctx.destination); osc.start(t0); osc.stop(t0+0.3);
    }catch(_){}
  }
}

/* ------------------ Shepard (pauses) ------------------ */
let shepRunning=false;
async function playShepard20s(){
  const wasActive = sessionActive && !paused;
  if(wasActive) pauseStart('shepard');
  await resumeCtx();
  const overlay=byId('shepardOverlay'), counterEl=byId('shepardCountdown');
  if(!overlay||!counterEl) return;
  overlay.style.display='flex'; shepRunning=true;
  const ctx=getCtx(); const oscillators=[]; const partials=8, base=55, dur=20; const now=ctx.currentTime;
  for(let i=0;i<partials;i++){
    const osc=ctx.createOscillator(); const g=ctx.createGain(); const f=base*Math.pow(2,i);
    osc.type='sine'; osc.frequency.setValueAtTime(f, now); osc.frequency.exponentialRampToValueAtTime(f/2, now+dur);
    const amp=Math.exp(-Math.pow((i-(partials-1)/2)/2,2)); g.gain.setValueAtTime(0.05*amp, now);
    osc.connect(g).connect(ctx.destination); oscillators.push(osc);
  }
  oscillators.forEach(o=>o.start(now)); oscillators.forEach(o=>o.stop(now+dur));
  let left=20; counterEl.textContent=left;
  const id=setInterval(()=>{ left--; counterEl.textContent=left; if(left<=0) clearInterval(id); },1000);
  await new Promise(r=>setTimeout(r,dur*1000));
  overlay.style.display='none'; shepRunning=false;
  if(wasActive){ pauseEnd(); safe('btnPause', el=> el.textContent='‚è∏ Pause'); }
}

/* ------------------ TRAINING FLOW ------------------ */
let autoNext=false, delayMs=1000;
let currentNote=null, truePc=null, isOOBTrial=false;
let firstRtBonusMs=0, inFlightTrial=false;
let suggestedRestartFlag=false;

/* Specials runtime */
let special=null; // {mode:'A'|'B', targetPc:'F', total:12|22, done:0, withFeedback:true, correct:0}

const PC2I={C:0,Db:1,D:2,Eb:3,E:4,F:5,Gb:6,G:7,Ab:8,A:9,Bb:10,B:11};
function currentOOBs(setSize){
  if(setSize>=12) return [];
  const learned = trainedSet(setSize).map(n=>PC2I[n]).sort((a,b)=>a-b);
  const low=learned[0], high=learned[learned.length-1];
  const up1=(high+1)%12, up2=(high+2)%12, dn1=(low+11)%12, dn2=(low+10)%12;
  const out=[];
  if(!learned.includes(up1)) out.push(PC[up1]);
  if(!learned.includes(up2) && !learned.includes(up1)) out.push(PC[up2]);
  if(!learned.includes(dn1)) out.push(PC[dn1]);
  if(!learned.includes(dn2) && !learned.includes(dn1)) out.push(PC[dn2]);
  return out;
}
function currentOctaves(){ return [4,5,6]; }
function rand(a){ return a[Math.floor(Math.random()*a.length)]; }
function pcLabel(pc){ return PC_LABEL[pc] || pc; }

function updateLevelUI(){
  const set=setFromIndex(state.levelIndex), block=blockFromIndex(state.levelIndex);
  text('setInfo', `Set ${set} / 12`);
  text('blockInfo', `Block ${block} / 24`);
  if(block >= 21){ text('accInfo', `Testing ‚Äî No Feedback`); }
  else{
    const req=(thresholdForIndex(state.levelIndex)*100).toFixed(0);
    const acc=((state.levelCorrect/state.levelTrials*100)||0).toFixed(0);
    text('accInfo', `Acc ${acc}% (req ${req}%)`);
  }
  text('delayInfo', `RT limit: ${rtWindowForSet(set)}ms ‚Ä¢ Delay: ${delayMs}ms`);
}

/* Build note pad and attach handlers */
function paintNotes(){
  const pad=byId('notePad'); if(!pad) return; pad.innerHTML='';
  const set=setFromIndex(state.levelIndex);
  const learned = new Set(trainedSet(set));
  const sorted = PC.filter(pc=> learned.has(pc));
  for(const pc of sorted){
    const b=document.createElement('button');
    b.textContent=pcLabel(pc);
    b.dataset.pc=pc;
    b.className='note';
    b.type='button';
    b.addEventListener('click', ()=> guess(pc));
    pad.appendChild(b);
  }
  safe('btnOOB', el=> {
    el.style.display = set>=12 ? 'none' : 'block';
    el.onclick = ()=> chooseOOB();
  });
}

/* Shepard gating for tests */
function maybeRunShepard(){
  const blk=blockFromIndex(state.levelIndex);
  if(!blockHasFeedback(blk) && state.shepardDoneFor!==state.levelIndex){
    state.shepardDoneFor=state.levelIndex; save();
    return playShepard20s();
  }
  return Promise.resolve();
}

/* ---------- Specials at BLOCK 15 (weakest from last 15 blocks) ---------- */
function chooseWeakestFromLastBlocks(nBlocks=15){
  const set = setFromIndex(state.levelIndex);
  const curBlock = blockFromIndex(state.levelIndex);
  const from = Math.max(1, curBlock - (nBlocks - 1));
  const trained = new Set(trainedSet(set));
  const windowTrials = (state.trials||[]).filter(t =>
    t.set === set && t.block >= from && t.block <= curBlock && t.block >= 1 && t.block <= 20
  );
  const stats = new Map();
  for(const pc of trained) stats.set(pc, {ok:0, n:0, order:UNLOCK_ORDER.indexOf(pc)});
  for(const t of windowTrials){ if(!trained.has(t.pc)) continue; const s=stats.get(t.pc); s.n++; if(t.correct) s.ok++; }
  let pick=null;
  for(const [pc,s] of stats){
    if(pick===null) pick={pc,...s};
    else if(s.ok < pick.ok || (s.ok===pick.ok && s.n > pick.n) || (s.ok===pick.ok && s.n===pick.n && s.order < pick.order)) pick={pc,...s};
  }
  return pick ? pick.pc : UNLOCK_ORDER[Math.min(set-1, UNLOCK_ORDER.length-1)];
}
function startSpecialAtBlock15(){
  const set = setFromIndex(state.levelIndex);
  if(set < 5) return false;
  if(blockFromIndex(state.levelIndex) !== 15) return false;
  if(state.specialRanForLevel === state.levelIndex) return false;
  state.specialRanForLevel = state.levelIndex; save();

  const targetPc = chooseWeakestFromLastBlocks(15);
  special = {mode:'A', targetPc, total:12, done:0, withFeedback:true, correct:0};
  showSpecialUI(true, `Special A ‚Äî focus: ${pcLabel(targetPc)}`);
  text('btnTarget', `Target (${pcLabel(targetPc)})`);
  text('btnOther',  'Other (OOB)');
  nextSpecialTrial(true);
  return true;
}
function showSpecialUI(show, label){
  if(show){
    showFlex('specialBar'); text('specialText', label||'Special Exercise');
    text('specialCount', '0 / 0');
    showBlock('binaryPad'); hide('notePad'); hide('btnOOB');
  }else{
    hide('specialBar'); hide('binaryPad'); showBlock('notePad');
    const set=setFromIndex(state.levelIndex);
    safe('btnOOB', el=> el.style.display = set>=12 ? 'none' : 'block');
  }
}
function nextSpecialTrial(){
  if(!special) return;
  const set=setFromIndex(state.levelIndex);
  const oobs = currentOOBs(set);
  const isTarget = Math.random()<0.5 || oobs.length===0;
  const pitchPc = isTarget ? special.targetPc : (oobs.length ? rand(oobs) : rand(PC.filter(p=>p!==special.targetPc)));
  truePc = pitchPc; isOOBTrial = !isTarget;
  currentNote = `${pitchPc}${rand(currentOctaves())}`;
  playSample(currentNote);
  clearTimeout(rtTimer); rtTimer=null; // no RT in specials
  text('promptPill','Target or Other?');
  text('specialCount', `${special.done} / ${special.total}`);
}
function endSpecialOrAdvance(){
  if(!special) return;
  if(special.done >= special.total){
    if(special.mode==='A'){
      special = {mode:'B', targetPc: special.targetPc, total:22, done:0, withFeedback:false, correct:0};
      showSpecialUI(true, `Special B ‚Äî focus: ${pcLabel(special.targetPc)}`);
      text('btnTarget', `Target (${pcLabel(special.targetPc)})`);
      nextSpecialTrial();
    }else{
      const trials = (state.trials||[]).filter(t=> (t.special==='A' || t.special==='B') && t.pc===special.targetPc);
      const ok = trials.filter(t=> t.correct).length;
      const n  = trials.length;
      const pct = n ? Math.round((ok/n)*1000)/10 : 0;
      alert(`üéâ Hooray! You identified ${pcLabel(special.targetPc)} at ${pct}% accuracy.`);
      special = null; showSpecialUI(false);
      text('promptPill','Specials done ‚Äî press Play to continue');
      /* one-shot suppress strict modal after specials */
      suppressStrictOnce = true;
    }
  }
}
function answerSpecial(userSaysTarget){
  if(!special) return;
  const correct = (userSaysTarget && !isOOBTrial) || (!userSaysTarget && isOOBTrial);
  state.trials.push({note:currentNote, pc:truePc, guess:userSaysTarget?'TARGET':'OTHER', correct, timeout:false, oob:isOOBTrial, set:setFromIndex(state.levelIndex), block:0, time:Date.now(), special:special.mode});
  save();
  if(special.withFeedback){
    feedback(correct, correct ? undefined : (isOOBTrial ? 'Incorrect ‚Äî Out of Bounds' : `Incorrect ‚Äî ${pcLabel(truePc)}`));
  }
  if(correct) special.correct = (special.correct||0) + 1;
  special.done++; text('specialCount', `${special.done} / ${special.total}`);
  if(special.done >= special.total) { endSpecialOrAdvance(); return; }
  setTimeout(()=> nextSpecialTrial(), Math.max(500, delayMs));
}

/* -------- Normal trials -------- */
function guess(pc){
  if(!sessionActive || paused || shepRunning || special) return;
  if(!currentNote){ return; }
  if(rtTimer){ clearTimeout(rtTimer); rtTimer=null; }
  const ok = (!isOOBTrial && pc === truePc);
  recordTrial(pc, ok, false, false);
  feedback(ok, ok ? undefined : (isOOBTrial ? 'Incorrect ‚Äî Out of Bounds' : `Incorrect ‚Äî ${pcLabel(truePc)}`));
  advanceCheck();
  scheduleAuto();
}
function chooseOOB(){
  if(!sessionActive || paused || shepRunning || special) return;
  if(!currentNote) return;
  if(rtTimer){ clearTimeout(rtTimer); rtTimer=null; }
  const ok = isOOBTrial;
  recordTrial('OOB', ok, false, true);
  const msg = ok ? undefined : `Incorrect ‚Äî ${pcLabel(truePc)}`;
  feedback(ok, msg);
  advanceCheck();
  scheduleAuto();
}

/* Driving */
function scheduleAuto(){ if(autoTimer){ clearTimeout(autoTimer); autoTimer=null; } if(autoNext && sessionActive && !paused && !shepRunning && !special){ autoTimer = setTimeout(()=> nextTrial(true), delayMs); } }
async function nextTrial(forceNew=false){
  if(!sessionActive || paused || shepRunning || special) return;
  if(inFlightTrial) return;

  /* clear the one-shot strict suppression as soon as normal play resumes */
  suppressStrictOnce = false;

  if(startSpecialAtBlock15()) return;

  inFlightTrial=true;
  try{
    await resumeCtx();
    await maybeRunShepard();
    if(paused || !sessionActive || special) return;
    if(!currentNote || forceNew){
      const set = setFromIndex(state.levelIndex);
      const usable = trainedSet(set);
      const oobs = currentOOBs(set);
      isOOBTrial = oobs.length && Math.random() < OOB_RATE;
      const pc = isOOBTrial ? rand(oobs) : rand(usable);
      truePc = pc;
      currentNote = `${pc}${rand(currentOctaves())}`;
    }
    await playSample(currentNote);
    if(rtTimer){ clearTimeout(rtTimer); rtTimer=null; }
    const baseRt = rtWindowForSet(setFromIndex(state.levelIndex));
    const rtms = baseRt + firstRtBonusMs + LATENCY_CUSHION_MS;
    firstRtBonusMs = 0;
    rtTimer = setTimeout(()=>handleTimeout(), rtms);
    text('promptPill','Listening‚Ä¶ choose the pitch');
  }catch(e){ report(e); }
  finally{ inFlightTrial=false; }
}
function handleTimeout(){
  if(!sessionActive || paused || special) return;
  if(rtTimer){ clearTimeout(rtTimer); rtTimer=null; }
  recordTrial(null,false,true);
  feedback(false, isOOBTrial ? 'Incorrect ‚Äî Out of Bounds' : `Incorrect ‚Äî ${pcLabel(truePc)}`);
  advanceCheck(); scheduleAuto();
}

/* Suggestion banner */
function hideSuggestBanner(){ hide('suggestBanner'); }
function showSuggestBanner(){ const set = setFromIndex(state.levelIndex); if(state.suggestShownSet === set) return; byId('suggestBanner').style.display='flex'; }
function restartCurrentSet(){
  const set = setFromIndex(state.levelIndex);
  state.levelIndex = (set-1)*LEVELS_PER_SET + 1;
  state.levelTrials = 0; state.levelCorrect = 0;
  state.shepardDoneFor = -1; state.testFailStreak = 0;
  state.suggestShownSet = null; save();
  updateLevelUI(); paintNotes();
  text('promptPill', `Restarted Set ${set}. Press Play to begin.`);
  hideSuggestBanner();
}
function maybeSuggestRestart(){
  const block = blockFromIndex(state.levelIndex);
  if(block < 21){ state.testFailStreak = 0; hideSuggestBanner(); suggestedRestartFlag=false; save(); return; }
  if(state.testFailStreak >= 4 && !suggestedRestartFlag){ suggestedRestartFlag = true; showSuggestBanner(); }
}

function recordTrial(guessLabel, ok, timeout=false, oobChosen=false){
  state.levelTrials++; if(ok) state.levelCorrect++;
  const block = blockFromIndex(state.levelIndex);
  if(block >= 21){ if(ok){ state.testFailStreak=0; hideSuggestBanner(); suggestedRestartFlag=false; } else { state.testFailStreak=(state.testFailStreak||0)+1; } }
  else { state.testFailStreak=0; hideSuggestBanner(); suggestedRestartFlag=false; }
  state.trials.push({note:currentNote, pc:truePc, guess:guessLabel, correct:ok, timeout, oob:oobChosen, set:setFromIndex(state.levelIndex), block:block, time:Date.now()});
  save(); updateLevelUI(); try{ drawChart(); }catch(_){}; 
  if(block >= 21 && !ok) maybeSuggestRestart();

  /* End-of-set summary for test blocks (21‚Äì24) */
  if(block===24 && state.levelTrials===20){
    try{
      const set=setFromIndex(state.levelIndex);
      const t=(state.trials||[]).filter(tr=> tr.set===set && tr.block>=21 && tr.block<=24);
      const ok2=t.filter(tr=>tr.correct).length, n2=t.length||1;
      const pct2=Math.round((ok2/n2)*1000)/10;
      const need=Math.round(THRESH_24[23]*1000)/10;
      const passed2=(ok2/n2)>=THRESH_24[23];
      alert(passed2 ? `üéâ Congrats ‚Äî you passed Set ${set} tests with ${pct2}% (req ${need}%).`
                    : `üò¨ Not quite ‚Äî you got ${pct2}% (req ${need}%).`);
    }catch(_){}
  }
}

function feedback(ok, wrongMsgOverride){
  const fb=blockHasFeedback(blockFromIndex(state.levelIndex));
  if(!fb && !special?.withFeedback) return;
  const box=byId('feedbackBox'); const overlay=byId('feedbackOverlay');
  if(!box||!overlay) return;
  box.style.background= ok? 'var(--good)':'var(--bad)';
  if(ok) box.textContent = 'Correct!';
  else   box.textContent = wrongMsgOverride || 'Incorrect';
  overlay.style.display='flex'; requestAnimationFrame(()=>overlay.classList.add('show'));
  setTimeout(()=>{ overlay.classList.remove('show'); overlay.style.display='none'; }, 500);
}

function advanceCheck(){
  if(state.levelTrials<20) return;
  const acc=state.levelCorrect/state.levelTrials, need=thresholdForIndex(state.levelIndex);
  const passed = acc>=need;
  const key = String(state.levelIndex);
  if(!passed){
    state.levelFailCounts[key] = (state.levelFailCounts[key]||0) + 1;
    if(state.levelFailCounts[key] >= 10){
      if(confirm('You‚Äôve attempted this level 10+ times without passing. Drop to a lower level?')){
        if(state.levelIndex>1) state.levelIndex--;
        state.levelTrials=0; state.levelCorrect=0; state.shepardDoneFor=-1;
        save(); updateLevelUI(); paintNotes();
        alert('Dropped one level. Keep going!');
        return;
      }
    }
  }else{
    state.levelFailCounts[key]=0;
  }
  state.levelTrials=0; state.levelCorrect=0;
  if(passed && state.levelIndex<LEVELS_TOTAL){
    state.levelIndex++;
    const wasBlock24=(blockFromIndex(prevLevelIdx)===24);
    if(wasBlock24){
      const nextSet=setFromIndex(state.levelIndex);
      const newPc=UNLOCK_ORDER[nextSet-1];
      try{ showPitchAddModal(newPc); }catch(_){}
    }
    save(); updateLevelUI(); paintNotes();
    startFlappyReward();
  } else save();
}

/* -------- Pitch-add modal -------- */
function showPitchAddModal(pc){
  const m=byId('pitchAddModal'); const t=byId('pitchAddText');
  if(!m||!t) return;
  t.textContent = `Well done ‚Äî now you are adding ${pcLabel(pc)}. Press ‚ÄúHear it‚Äù to preview this pitch before you start.`;
  m.style.display='flex';
  safe('pitchAddHear', btn=> btn.onclick=()=> playSample(`${pc}${rand(currentOctaves())}`));
  safe('pitchAddClose', btn=> btn.onclick=()=> (m.style.display='none'));
}
/* ------------------ SESSION ------------------ */
function startSession(){
  stopAllTimers();
  sealDanglingSession();
  if(isLocked()){
    const left = state.lockoutUntil - Date.now();
    alert(`Training is locked for ${fmtHMM(left)}.\nYou can still play Flappy from the menu, or Reset lockout/timer.`);
    showScreen('menuScreen'); return;
  }
  showScreen('trainerScreen');
  if(!state.startDate) state.startDate=Date.now();
  ensureWeekRoll();
  sessionActive=true; paused=false;
  (state.sessions||[]).push({start:Date.now(),end:null,pauses:[],completed:false}); 
  state.lastSeen = Date.now(); save();
  updateCapsUI(); updateLevelUI(); paintNotes();
  text('promptPill','Press Play to start');
  stopAllTimers();
  tickId=setInterval(()=>{
    ensureWeekRoll();
    if(sessionActive && !paused && !shepRunning){ state.thisWeekMs = (state.thisWeekMs||0) + 1000; save(); }
    if(sessionActive && !paused){
      const left = Math.max(0, SESS_DAILY_MS - msUsedQuota());
      text('timerInfo', `Time left: ${fmtMMSS(left)}`);
      if(left<=0){
        const now = Date.now();
        const rec=state.sessions[state.sessions.length-1];
        if(rec && !rec.completed){ rec.completed=true; rec.end = now; }
        state.lockoutUntil = now + LOCKOUT_MS;
        state.capResetAt   = state.lockoutUntil;
        save(); endSession(true);
      }
    }
    updateCapsUI(); drawChart();
  },1000);
}
function endSession(auto){
  if(!sessionActive) return;
  sessionActive=false;
  stopAllTimers();
  const rec=state.sessions[state.sessions.length-1]; if(rec && !rec.end) rec.end=Date.now();
  save(); updateCapsUI(); try{ drawChart(); }catch(_){};
  if(auto){
    const left = state.lockoutUntil ? fmtHMM(state.lockoutUntil - Date.now()) : 'some time';
    alert(`Cap reached. Locked for ${left}.`);
  }
}
function pauseStart(reason){
  const rec=state.sessions[state.sessions.length-1]; if(!rec) return;
  rec.pauses=rec.pauses||[]; const last=rec.pauses[rec.pauses.length-1];
  if(!(last && !last.end)) rec.pauses.push({start:Date.now(), end:null, reason});
  paused=true;
  if(rtTimer){ clearTimeout(rtTimer); rtTimer=null; }
  if(autoTimer){ clearTimeout(autoTimer); autoTimer=null; }
}
function pauseEnd(){
  const rec=state.sessions[state.sessions.length-1]; if(!rec||!rec.pauses||!rec.pauses.length) return;
  const last=rec.pauses[rec.pauses.length-1]; if(last && !last.end) last.end=Date.now();
  paused=false;
}
function pauseResume(){
  if(!sessionActive) return;
  if(paused){ pauseEnd(); safe('btnPause', el=> el.textContent='‚è∏ Pause'); if(special) nextSpecialTrial(); else if(currentNote){ nextTrial(false); } }
  else { safe('btnPause', el=> el.textContent='‚ñ∂ Resume'); pauseStart('user'); }
}

/* ------------------ QUOTA ------------------ */
function quotaStart(){ if(state.capResetAt && Date.now() >= state.capResetAt) return state.capResetAt; const d = new Date(); d.setHours(0,0,0,0); return d.getTime(); }
function msUsedQuota(){ const start = quotaStart(); return (state.sessions || []).filter(s => s.start >= start).reduce((a, s) => a + activeDuration(s), 0); }

/* ------------------ PROGRESS / CHARTS ------------------ */
function eightWeekBins(pitch){
  const t0=todayKey(Date.now());
  const bins=[];
  for(let w=1; w<=8; w++){ const start=t0 - (w-1)*7*86400000; const end=start+7*86400000; bins.push({w,start,end,n:0,ok:0}); }
  const oldest=bins[7].start;
  const trials=(state.trials||[]).filter(tr=>{
    const d=dateAtMidnight(tr.time);
    return d>=oldest && d<bins[0].end && (pitch==='OVERALL'|| tr.pc===pitch);
  });
  for(const tr of trials){
    const d=dateAtMidnight(tr.time);
    const daysAgo=Math.floor((t0 - d)/86400000);
    const w=Math.floor(daysAgo/7)+1;
    const idx=Math.min(8,Math.max(1,w))-1;
    const b=bins[idx]; b.n++; if(tr.correct) b.ok++;
  }
  return bins;
}
function thisWeekBins(pitch){
  const ws = weekStartTs();
  const bins=[];
  for(let i=0;i<7;i++){ bins.push({day:i+1,start:ws+i*86400000,end:ws+(i+1)*86400000,n:0,ok:0}); }
  const trials=(state.trials||[]).filter(tr=> tr.time>=ws && tr.time<ws+7*86400000 && (pitch==='OVERALL'|| tr.pc===pitch));
  for(const tr of trials){
    const day = Math.floor((dateAtMidnight(tr.time) - ws)/86400000);
    const b = bins[Math.max(0, Math.min(6, day))]; b.n++; if(tr.correct) b.ok++;
  }
  return bins;
}
function drawLine(ctx, pts, color, xscale, yscale){ ctx.beginPath(); let started=false; for(const p of pts){ if(p.y===null) continue; const x=xscale(p.x), y=yscale(p.y); if(!started){ ctx.moveTo(x,y); started=true; } else ctx.lineTo(x,y); } if(!started) return; ctx.strokeStyle=color; ctx.lineWidth=2.5; ctx.stroke(); }
function drawDot(ctx, x, y, color, r=6){ ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fillStyle=color; ctx.fill(); }
function drawChart(){
  const dataMode = byId('dataSelect')?.value || 'TRAINING';
  const canvas = byId('progressCanvas'); if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);
  const P={l:56,r:24,t:16,b:28}; const AX=P.l, AY=P.t, AW=W-P.l-P.r, AH=H-P.t-P.b;
  ctx.fillStyle='#0b1224'; ctx.fillRect(0,0,W,H);
  const mode=byId('granularitySelect')?.value||'WEEKLY';
  const pitch=byId('pitchSelect')?.value||'OVERALL';
  const colGood=getComputedStyle(document.documentElement).getPropertyValue('--good')||'#16a34a';
  const colNeutral=getComputedStyle(document.documentElement).getPropertyValue('--neutral')||'#94a3b8';
  const yscale=(v)=> AY + AH - (v/100)*AH;

  /* Y grid + labels */
  ctx.strokeStyle='#20314d'; ctx.lineWidth=1; ctx.beginPath();
  for(let gy=0; gy<=100; gy+=20){ const y=yscale(gy); ctx.moveTo(AX,y); ctx.lineTo(AX+AW,y);} ctx.stroke();
  ctx.fillStyle='rgba(229,231,235,0.9)'; ctx.font='12px system-ui,sans-serif';
  for(let gy=0; gy<=100; gy+=20){ const y=yscale(gy)+4; ctx.fillText(String(gy)+'%', 8, y); }

  /* TEST data */
  if(dataMode==='TEST'){
    const tests=(state.mixedTests||[]);
    const n = tests.length;
    const xscale=(i)=> AX + (n>1? ((i-1)/(n-1))*AW : AW/2 + AX);
    ctx.strokeStyle='#20314d'; ctx.beginPath();
    for(let i=1;i<=Math.max(1,n);i++){ const x=xscale(i); ctx.moveTo(x,AY); ctx.lineTo(x,AY+AH);} ctx.stroke();
    ctx.fillStyle='rgba(229,231,235,0.9)'; for(let i=1;i<=n;i++){ ctx.fillText('#'+i, xscale(i)-8, H-6); }
    const pts=tests.map((t,i)=> ({x:i+1, y: Math.round((t.ok/t.n)*1000)/10 }));
    const colGood=getComputedStyle(document.documentElement).getPropertyValue('--good')||'#16a34a';
    const accPts=pts;
    drawLine(ctx, accPts, colGood, xscale, y=> AY + AH - (y/100)*AH);
    for(const p of pts){ drawDot(ctx, xscale(p.x), yscale(p.y), colGood, 6); }
    ctx.fillStyle='rgba(229,231,235,0.85)'; ctx.font='13px system-ui,sans-serif';
    ctx.fillText('Mixed Test', AX, AY-2);
    return;
  }

  if(mode==='WEEKLY'){
    const bins=thisWeekBins(pitch);
    const xscale=(d)=> AX + ((d - 1)/(7 - 1))*AW;
    ctx.strokeStyle='#20314d'; ctx.beginPath();
    for(let d=1; d<=7; d++){ const x=xscale(d); ctx.moveTo(x,AY); ctx.lineTo(x,AY+AH);} ctx.stroke();
    ctx.fillStyle='rgba(229,231,235,0.9)';
    for(let d=1; d<=7; d++){ const x=xscale(d); ctx.fillText(`Day ${d}`, x-18, H-6); }
    const pts=bins.map(b=> b.n===0? {x:b.day,y:null}:{x:b.day,y:Math.round((b.ok/b.n)*1000)/10});
    const accPts=pts.filter(p=> p.y!==null);
    drawLine(ctx,accPts,colGood,xscale,yscale);
    for(const b of bins){
      if(b.n>0) drawDot(ctx,xscale(b.day), yscale(Math.round((b.ok/b.n)*1000)/10), colGood, 6);
      else      drawDot(ctx,xscale(b.day), yscale(0), colNeutral, 5);
    }
  } else {
    const weeks=eightWeekBins(pitch);
    const xscale=(w)=> AX + ((w - 1)/(8 - 1))*AW;
    ctx.strokeStyle='#20314d'; ctx.beginPath();
    for(let w=1; w<=8; w++){ const x=xscale(w); ctx.moveTo(x,AY); ctx.lineTo(x,AY+AH);} ctx.stroke();
    ctx.fillStyle='rgba(229,231,235,0.9)';
    for(let w=1; w<=8; w++){ const x=xscale(w); ctx.fillText(`Week ${w}`, x-22, H-6); }
    const pts=weeks.map(b=> b.n===0? {x:b.w,y:null}:{x:b.w,y:Math.round((b.ok/b.n)*1000)/10});
    const accPts=pts.filter(p=> p.y!==null);
    drawLine(ctx,accPts,colGood,xscale,yscale);
    for(const p of weeks){
      if(p.n>0) drawDot(ctx,xscale(p.w), yscale(Math.round((p.ok/p.n)*1000)/10), colGood, 5);
      else      drawDot(ctx,xscale(p.w), yscale(0), colNeutral, 4);
    }
  }
  ctx.fillStyle='rgba(229,231,235,0.85)'; ctx.font='13px system-ui,sans-serif';
  const label=(pitch==='OVERALL')?'Overall':`Pitch: ${pcLabel(pitch)}`;
  ctx.fillText(label, AX, AY-2);
}

/* Pitch dropdown + view toggle */
function populatePitchSelect(){
  const sel = byId('pitchSelect'); if(!sel) return;
  sel.innerHTML='';
  const mk=(v,t)=>{ const o=document.createElement('option'); o.value=v; o.textContent=t; return o; };
  sel.appendChild(mk('OVERALL','Overall'));
  PC.forEach(pc=> sel.appendChild(mk(pc, pcLabel(pc))));
  sel.onchange = ()=> drawChart();
  const gran = byId('granularitySelect'); if(gran){ gran.onchange = ()=> drawChart(); gran.value='WEEKLY'; }
}

/* ------------------ TUTORIAL PAGER ------------------ */
let tIndex = 0;
function setTutorialPage(i){
  tIndex = Math.max(0, Math.min(4, i));
  ['tPage1','tPage2','tPage3','tPage4','tPage5'].forEach((id, idx)=>{
    const el = byId(id);
    if(el) el.classList.toggle('active', idx===tIndex);
  });
  const back = byId('tBack'); if(back) back.style.visibility = (tIndex===0 ? 'hidden' : 'visible');
  const next = byId('tNext'); if(next) next.textContent = (tIndex===4 ? 'Got it' : 'Next ‚ñ∂');
}
function nextTutorial(){ if(tIndex<4){ setTutorialPage(tIndex+1); return; } hide('welcomeModal'); showScreen('menuScreen'); updateCapsUI(); populatePitchSelect(); drawChart(); }
function prevTutorial(){ setTutorialPage(tIndex-1); }

/* ------------------ WIRING ------------------ */
function wireOnce(){
  sealDanglingSession();
  try{ populatePitchSelect(); drawChart(); }catch(_){}
  // Start
  safe('startBtn', el=> el.onclick=()=>{
    const name=(byId('userNameInput')?.value||'').trim()||'Player';
    state.userName=name; save();
    safe('greeting', g=> g.textContent=`Hello ${state.userName}!`);
    showFlex('welcomeModal'); setTutorialPage(0);
  });
  safe('tNext', el=> el.onclick=()=> nextTutorial());
  safe('tBack', el=> el.onclick=()=> prevTutorial());

  // Menu
  safe('menuStart',   el=> el.onclick=()=> startSession());
  safe('playFlappy',  el=> el.onclick=()=> openFlappyFromMenu());
  safe('resetLockout',el=> el.onclick=()=>{
    if(!confirm('Reset lockout/timer now? This starts a fresh 20-minute window immediately.')) return;
    state.lockoutUntil = null; state.capResetAt = Date.now(); state.lastSeen = Date.now();
    save(); updateCapsUI(); alert('Timer reset. You can start training now.');
  });
  safe('menuReset',   el=> el.onclick=()=> doFactoryReset());

  // Set selector
  safe('setSizeSelect', sel=>{
    if(!sel.options.length){
      for(let i=1;i<=SETS;i++){
        const o=document.createElement('option');
        o.value=i; o.textContent=`${i} ${i===1?'pitch':'pitches'}`;
        sel.appendChild(o);
      }
    }
    sel.value = String(setFromIndex(state.levelIndex));
  });
  safe('applySetBtn', el=> el.onclick=()=>{
    const v = parseInt(byId('setSizeSelect')?.value||'1',10)||1;
    state.levelIndex=(v-1)*LEVELS_PER_SET+1; state.levelTrials=0; state.levelCorrect=0; state.shepardDoneFor=-1; state.testFailStreak=0; suggestedRestartFlag=false; state.suggestShownSet=null; save();
    alert(`Scope set to ${v} ${v===1?'pitch':'pitches'} (Block 1/24)`); paintNotes();
  });

  // Trainer controls
  safe('btnPlay',        el=> el.onclick=async()=>{ firstRtBonusMs=2000; await resumeCtx(); if(paused){ pauseEnd(); } safe('btnPause', b=> b.textContent='‚è∏ Pause'); if(special) nextSpecialTrial(); else nextTrial(true); });
  safe('btnPause',       el=> el.onclick=()=> pauseResume());
  safe('btnBackMenu',    el=> el.onclick=()=>{
    if(sessionActive){ if(!paused) pauseStart('user-leave'); openStrictModal(); }
    else { showScreen('menuScreen'); populatePitchSelect(); drawChart(); }
  });
  safe('btnToggleAuto',  el=> el.onclick=()=>{
    autoNext=!autoNext; text('autoInfo',`Auto-next: ${autoNext?'On':'Off'}`);
    const sl=byId('delaySlider'); if(sl){ sl.disabled=!autoNext; sl.classList.toggle('disabled', !autoNext); }
    if(!autoNext && autoTimer){ clearTimeout(autoTimer); autoTimer=null; }
  });
  safe('delaySlider', sl=>{
    sl.disabled=true; sl.classList.add('disabled');
    sl.oninput=(e)=>{ delayMs=parseInt(e.target.value,10)||0; updateLevelUI(); };
  });

  // Specials
  safe('btnTarget',el=> el.onclick=()=> answerSpecial(true));
  safe('btnOther', el=> el.onclick=()=> answerSpecial(false));

  // Strict modal buttons
  safe('btnStrictResume', el=> el.onclick=()=>{ closeStrictModal(); showScreen('trainerScreen'); });
  safe('btnStrictMenu',   el=> el.onclick=()=>{ closeStrictModal(); showScreen('menuScreen'); });

  // Initial screen
  safe('dataSelect', el=> el.onchange=()=> drawChart());
  if(!state.userName){ showScreen('startScreen'); }
  else { safe('greeting', g=> g.textContent=`Hello ${state.userName}!`); showScreen('menuScreen'); updateCapsUI(); }
}


/* ------------------ Mixed Test (sine + piano) ------------------ */
let mRunning=false, mDone=0, mCorrect=0, mTruePc=null, mNote=null, mIsSine=false;
function buildMixedPad(){
  const pad=byId('mixedPad'); if(!pad) return;
  pad.innerHTML='';
  const sorted = PC.slice();
  for(const pc of sorted){
    const b=document.createElement('button');
    b.className='note';
    b.type='button';
    b.textContent=pcLabel(pc);
    b.onclick=()=> guessMixed(pc);
    pad.appendChild(b);
  }
  text('mixedStatus','Ready ‚Äî 20 trials');
}
function startMixedTest(){
  if(mRunning) return;
  mRunning=true; mDone=0; mCorrect=0; mTruePc=null; mNote=null;
  text('mixedStatus','Playing‚Ä¶');
  nextMixedTrial(true);
}
function nextMixedTrial(){
  if(!mRunning) return;
  try{
    mTruePc = rand(PC);
    const oct = rand(currentOctaves());
    mIsSine = Math.random()<0.5;
    mNote = `${mTruePc}${oct}`;
    if(mIsSine){
      (async ()=>{
        try{
          await resumeCtx();
          const ctx=getCtx();
          const idx={C:0,Db:1,D:2,Eb:3,E:4,F:5,Gb:6,G:7,Ab:8,A:9,Bb:10,B:11};
          const semis=(idx[mTruePc]??9)+(oct-4)*12;
          const freq=440*Math.pow(2,(semis-9)/12);
          const osc=ctx.createOscillator(); const g=ctx.createGain();
          osc.type='sine'; osc.frequency.value=freq;
          const t0=ctx.currentTime; g.gain.setValueAtTime(0.0001,t0); g.gain.linearRampToValueAtTime(0.25,t0+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t0+TONE_MS/1000);
          osc.connect(g).connect(ctx.destination); osc.start(t0); osc.stop(t0+TONE_MS/1000);
        }catch(_){}
      })();
    }else{
      playSample(mNote);
    }
    text('mixedStatus',`Trial ${mDone+1} / 20 ‚Äî choose the pitch`);
  }catch(e){ report(e); }
}
function guessMixed(pc){
  if(!mRunning || !mTruePc) return;
  const ok = (pc===mTruePc);
  mDone++; if(ok) mCorrect++;
  if(mDone>=20){
    mRunning=false;
    const pct = Math.round((mCorrect/20)*1000)/10;
    alert(`Mixed Test complete ‚Äî you got ${pct}%.`);
    (state.mixedTests=state.mixedTests||[]).push({time:Date.now(), n:20, ok:mCorrect});
    save(); drawChart(); text('mixedStatus','Finished ‚Äî start again to add a new point');
  }else{
    setTimeout(()=> nextMixedTrial(), 400);
  }
}

/* ------------------ FLAPPY ------------------ */
let fCtx, flappyRAF=null, running=false, score=0, pipes=[], bird, pipeTimer=0, lastTs=null;

/* Flappy now: start with bigger gap, shrink over first 5 pipes, then keep constant.
   Speed still scales with score. */
const FLAPPY = { gravity:900, flap:-380, baseSpeed:140, maxSpeed:260, speed:140, baseGap:140, gap:140, introPipes:5, introExtra:60, spawnEvery:1.20, width:52 };

function openFlappyFromMenu(){ if(isLocked()) openFlappyModal(); else alert('Flappy is intended for lockout/rewards.'); }
function openFlappyModal(){ byId('flappyModal').style.display='flex'; const c=byId('flappyCanvas'); if(!c) return; fCtx=c.getContext('2d'); resetFlappy(); attachFlappyControls(); }
function startFlappyReward(){ if(sessionActive && !paused){ pauseStart('flappy'); } clearTimeout(rtTimer); rtTimer=null; clearTimeout(autoTimer); autoTimer=null; openFlappyModal(); }
function closeFlappy(){
  running=false; cancelAnimationFrame(flappyRAF); byId('flappyModal').style.display='none'; detachFlappyControls();
  if(score > (state.flappyHighScore||0)){ state.flappyHighScore = score; save(); }
  if(sessionActive){
    safe('btnPause', el=> el.textContent='‚ñ∂ Resume');
    currentNote=null; clearTimeout(rtTimer); rtTimer=null; clearTimeout(autoTimer); autoTimer=null;
    text('promptPill','Flappy over ‚Äî press Play to continue');
  }
}
function resetFlappy(){ const cnv=byId('flappyCanvas'); if(!cnv) return; bird={x:60,y:cnv.height/2,vy:0,wing:0}; pipes=[]; score=0; pipeTimer=0; lastTs=null; FLAPPY.speed=FLAPPY.baseSpeed; FLAPPY.gap=FLAPPY.baseGap + FLAPPY.introExtra; FLAPPY.introPipes=5; text('flappyScore',`Score: 0 ‚Ä¢ Best: ${state.flappyHighScore||0}`); }
function flap(){ bird.vy = FLAPPY.flap; const pc = rand(PC); const note = `${pc}${rand(currentOctaves())}`; playSample(note); }
function progressiveDifficulty(){ // only speed scales; gap remains constant after intro
  const target = FLAPPY.baseSpeed + Math.min(Math.floor(score/5)*18, FLAPPY.maxSpeed - FLAPPY.baseSpeed);
  FLAPPY.speed = target;
}
function drawBird(){ const ctx=fCtx; if(!ctx) return; const body=getComputedStyle(document.documentElement).getPropertyValue('--accent')||'#fbbf24'; const wingCol='#ffd166'; const outline='#111';
  ctx.save();
  const tilt=Math.max(-0.6,Math.min(0.6,bird.vy/380)); ctx.translate(bird.x,bird.y); ctx.rotate(tilt);
  ctx.fillStyle=body; ctx.beginPath(); ctx.arc(0,0,10,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(3,-4,3,0,Math.PI*2); ctx.fill();
  ctx.fillStyle=outline; ctx.beginPath(); ctx.arc(4,-4,1.5,0,Math.PI*2); ctx.fill();
  bird.wing+=0.25; const wing=Math.sin(bird.wing)*0.9; ctx.save(); ctx.rotate(wing);
  ctx.fillStyle=wingCol; ctx.beginPath(); ctx.moveTo(-2,2); ctx.quadraticCurveTo(-16,4,-8,12); ctx.quadraticCurveTo(0,10,-2,2); ctx.fill();
  ctx.strokeStyle='rgba(0,0,0,0.35)'; ctx.lineWidth=1.5; ctx.stroke();
  ctx.restore();
  ctx.restore();
}
function drawPipes(){ const ctx=fCtx; if(!ctx) return; const col=getComputedStyle(document.documentElement).getPropertyValue('--good')||'#16a34a'; ctx.fillStyle=col; const cnv=byId('flappyCanvas'); if(!cnv) return; for(const p of pipes){ const topH=p.gapY-FLAPPY.gap/2, bottomY=p.gapY+FLAPPY.gap/2; ctx.fillRect(p.x,0,FLAPPY.width,topH); ctx.fillRect(p.x,bottomY,FLAPPY.width,cnv.height-bottomY); } }
function spawnPipe(){
  const cnv=byId('flappyCanvas'); if(!cnv) return;
  const h=cnv.height, m=40;

  // intro ramp: linearly reduce gap to baseGap across first 5 pipes
  if(FLAPPY.introPipes > 0){
    const k = FLAPPY.introPipes; // 5..1
    const extraNow = Math.round(FLAPPY.introExtra * (k/5));
    FLAPPY.gap = FLAPPY.baseGap + extraNow;
    FLAPPY.introPipes--;
    if(FLAPPY.introPipes === 0) FLAPPY.gap = FLAPPY.baseGap; // lock it
  }

  const gapY=Math.max(m,Math.min(h-m-FLAPPY.gap,Math.random()*(h-FLAPPY.gap-2*m)))+FLAPPY.gap/2;
  pipes.push({x: cnv.width, gapY: gapY, passed:false});
}
function step(ts){
  if(!running) return;
  const cnv=byId('flappyCanvas'); if(!cnv) return;
  if(lastTs===null) lastTs = ts;
  let dt = (ts - lastTs) / 1000; if(dt > 0.033) dt = 0.033; lastTs = ts;
  bird.vy += FLAPPY.gravity * dt; bird.y  += bird.vy * dt;
  pipeTimer -= dt; if(pipeTimer <= 0){ pipeTimer += FLAPPY.spawnEvery; spawnPipe(); }
  for(const p of pipes){ p.x -= FLAPPY.speed * dt; }
  for(const p of pipes){ if(!p.passed && p.x + FLAPPY.width < bird.x){ p.passed = true; score++; progressiveDifficulty(); text('flappyScore',`Score: ${score} ‚Ä¢ Best: ${state.flappyHighScore||0}`); } }
  pipes = pipes.filter(p=> p.x + FLAPPY.width > 0);
  fCtx.clearRect(0,0,cnv.width,cnv.height); drawPipes(); drawBird();
  if(bird.y < 0 || bird.y > cnv.height){ return closeFlappy(true); }
  for(const p of pipes){ if(bird.x+10>p.x && bird.x-10<p.x+FLAPPY.width){ const topH=p.gapY-FLAPPY.gap/2, bottomY=p.gapY+FLAPPY.gap/2; if(bird.y-10<topH || bird.y+10>bottomY){ return closeFlappy(true); } } }
  flappyRAF = requestAnimationFrame(step);
}
let _flHandlers=null;
function attachFlappyControls(){
  const cnv=byId('flappyCanvas'); if(!cnv) return;
  const startOrFlap = () => { if(!running){ running=true; resetFlappy(); flappyRAF=requestAnimationFrame(step); } else { flap(); } };
  const onCanvasClick  = (e)=>{ e.preventDefault(); startOrFlap(); };
  const onTouchStart   = (e)=>{ e.preventDefault(); startOrFlap(); };
  const onKey          = (e)=>{ if(e.code==='Space'){ e.preventDefault(); startOrFlap(); } };
  const onClose        = ()=> closeFlappy(false);
  cnv.addEventListener('click', onCanvasClick);
  cnv.addEventListener('touchstart', onTouchStart, { passive:false });
  window.addEventListener('keydown', onKey);
  safe('flappyClose', el=> el.onclick=onClose);
  _flHandlers={onCanvasClick,onTouchStart,onKey,onClose};
}
function detachFlappyControls(){
  const cnv=byId('flappyCanvas'); if(!_flHandlers||!cnv) return;
  cnv.removeEventListener('click', _flHandlers.onCanvasClick);
  cnv.removeEventListener('touchstart', _flHandlers.onTouchStart);
  window.removeEventListener('keydown', _flHandlers.onKey);
  safe('flappyClose', el=> el.onclick=null);
}

/* ------------------ STRICT MODAL + NAV GUARDS ------------------ */
let strictModalPending=false;
function openStrictModal(){ if(suppressStrictOnce){ suppressStrictOnce=false; return; } showFlex('strictModal'); setTimeout(()=> byId('btnStrictResume')?.focus(), 0); }
function closeStrictModal(){ hide('strictModal'); strictModalPending=false; }
function reconcileAwayTime(){
  const now = Date.now();
  const rec = (state.sessions||[])[(state.sessions||[]).length - 1];
  if(rec && rec.pauses && rec.pauses.length){
    const openPause = rec.pauses[rec.pauses.length-1];
    if(openPause && !openPause.end){ openPause.end = now; save(); }
  }
  state.lastSeen = now; save();
}
document.addEventListener('visibilitychange', ()=>{
  if(document.hidden && sessionActive && !paused){ pauseStart('hidden'); strictModalPending = true; }
  if(!document.hidden){ reconcileAwayTime(); if(strictModalPending && !suppressStrictOnce) openStrictModal(); strictModalPending=false; }
});
window.addEventListener('blur', ()=>{ if(sessionActive && !paused){ pauseStart('blur'); strictModalPending = true; } });
window.addEventListener('focus', ()=>{ reconcileAwayTime(); if(strictModalPending && !suppressStrictOnce) openStrictModal(); strictModalPending=false; });
window.addEventListener('pagehide', ()=>{ try{ if(sessionActive && !paused){ pauseStart('pagehide'); strictModalPending = true; } state.lastSeen = Date.now(); save(); }catch(_){}});

/* --- beforeunload guard --- */
let allowUnloadOnce = false;
window.addEventListener('beforeunload', (e)=>{
  if(allowUnloadOnce) return;
  if(sessionActive && !paused){ e.preventDefault(); e.returnValue=''; }
});

/* ------------------ FACTORY RESET ------------------ */
async function wipeAllStorage(){ try{ localStorage.clear(); }catch(_){}
  try{ sessionStorage.clear(); }catch(_){}
  if('caches' in window){ try{ const keys = await caches.keys(); await Promise.all(keys.map(k=>caches.delete(k))); }catch(_){ } }
  if('indexedDB' in window){
    try{
      if(indexedDB.databases){
        const dbs = await indexedDB.databases();
        await Promise.all((dbs||[]).map(db=> db && db.name ? new Promise(res=>{ const rq = indexedDB.deleteDatabase(db.name); rq.onsuccess=rq.onerror=rq.onblocked=()=>res(); }) : Promise.resolve()));
      }
    }catch(_){}
  }
}
function forceStartScreen(){
  document.querySelectorAll('.screen').forEach(el=> el.style.display='none');
  const input = byId('userNameInput');
  byId('startScreen').style.display='block';
  if(input){ input.value=''; input.focus(); }
}
function resetInMemoryStateToDefaults(){
  state = { userName:null, levelIndex:1, levelTrials:0, levelCorrect:0, shepardDoneFor:-1, sessions:[], trials:[], startDate:null, lockoutUntil:null, capResetAt:null, testFailStreak:0, suggestShownSet:null, lastSeen:null, flappyHighScore:0, thisWeekIdx:0, thisWeekMs:0, levelFailCounts:{}, specialRanForLevel:null };
  save();
}
function doFactoryReset(){
  (async ()=>{
    try{
      if(!confirm('Reset EVERYTHING to factory settings? This erases your progress, timers, and settings.')) return;
      stopAllTimers(); sessionActive=false; paused=false;
      await closeAudio(); await wipeAllStorage(); resetInMemoryStateToDefaults(); forceStartScreen();
      allowUnloadOnce = true; setTimeout(()=>{ try{ location.reload(); }catch(_){ } }, 0);
    }catch(e){ report(e); alert('Reset failed: '+e.message); }
  })();
}

/* ------------------ INIT ------------------ */
window.addEventListener('load', wireOnce);
window.addEventListener('resize', ()=>{ try{ drawChart(); }catch(_){ }});
</script>
</body>
</html>
